import * as vscode from 'vscode';

/**
 * 界面语言：默认中文；用户可在 VS Code 设置中将 knowledgeBase.displayLanguage 设为 "en" 切换为英文。
 */
function getDisplayLanguage(): string {
    return vscode.workspace.getConfiguration('knowledgeBase').get<string>('displayLanguage') ?? 'zh';
}

export const isChinese = (): boolean =>
    getDisplayLanguage() !== 'en';

/** 用于 HTML lang 属性，与界面语言一致 */
export const htmlLang = (): string => (isChinese() ? 'zh-CN' : 'en');

export type Messages = Record<string, Record<string, string>>;

const zh: Messages = {
    common: {
        openPreview: '打开预览',
        openFile: '打开文件',
        copyPath: '复制绝对路径',
        copyRelativePath: '复制相对路径',
    },
    msg: {
        revealFailed: '无法在 Finder 中打开',
        copiedAbsolutePath: '已复制绝对路径到剪贴板',
        copiedAbsolutePathMulti: '已复制 {n} 个文件的绝对路径',
        copyPathFailed: '复制路径失败',
        copiedRelativePath: '已复制相对路径到剪贴板',
        copiedRelativePathMulti: '已复制 {n} 个文件的相对路径',
        copyRelativePathFailed: '复制相对路径失败',
        copyFileSuffix: '副本',
        copyFileSuffixWithNum: '副本 {n}',
        copiedFile: '已复制文件: {name}',
        copyFileFailed: '复制文件失败',
        noWorkspace: '请先打开一个工作区',
        noMatch: '未找到匹配的笔记',
        noMatchFallback: '未找到同时包含所有关键词的文件，显示包含任一关键词的 {n} 个结果',
        expandAllLater: '全部展开功能将在后续版本优化',
        noActiveEditor: '没有活动的编辑器',
        selectFileFirst: '请先选择一个文件',
        openFileFirst: '请先打开一个文件',
        unknownFile: '无法识别当前文件',
        openFailed: '打开失败',
        installFailed: '安装失败',
        deleteFailed: '删除失败',
    },
    search: {
        prompt: '输入搜索关键词',
        placeHolder: '支持单个关键词或多个关键词（空格分隔）',
        cleared: '搜索结果已清空',
        matchCount: '匹配次数',
        matches: '{n} 处匹配',
    },
    coraWiki: {
        emptyHint: '点击标题栏按钮开始 CoraWiki 研究',
        welcomeIntro: 'CoraWiki 将使用 AI 自动分析代码架构，生成代码架构分析报告。',
        welcomeButton: '开始分析当前工作区架构',
        latestReportTag: '最新',
        referencesTitle: '证据引用',
        queryPrompt: '输入要研究的代码问题',
        queryPlaceholder: '例如：订单创建后到落库的完整链路是什么？',
        running: 'CoraWiki 正在分析代码...',
        keyMissing: '未检测到环境变量 {env}，将降级为本地模式运行',
        runFailed: 'CoraWiki 运行失败：{error}',
        reportSaved: 'CoraWiki 报告已生成：{path}',
        alreadyRunning: '已有分析任务在运行，请等待完成或点击通知中的「取消」终止',
        cancelled: 'CoraWiki 分析已终止',
        noReportFound: '尚未找到 CoraWiki 报告，请先执行一次研究',
        openReportFailed: '打开 CoraWiki 报告失败：{error}',
        openReferenceFailed: '打开引用失败：{ref}，错误：{error}',
        deleteReportConfirm: '确定要删除报告“{name}”吗？',
        deleteReportConfirmMulti: '确定要删除选中的 {n} 个报告吗？',
        deleteAction: '删除',
        deleteReportDone: '报告已删除',
        deleteReportDoneMulti: '已删除 {n} 个报告',
        deleteReportFailed: '删除报告失败：{error}',
        pythonNotFound: '未检测到 Python 或 CoraWiki Python 环境不可用。是否跳过本研究的 Python 分析？',
        pythonSkip: '跳过',
        pythonOpenWebsite: '打开 Python 官网',
        pythonError: 'Python 执行出错：{error}。如何解决？',
        pythonRetry: '重试',
    },
    cmd: {
        openPlanConstraints: '打开 Plan 约束说明',
        openPlanReadme: '打开 README 登记表',
        installPlanConstraintsToWorkspace: '安装 Plan 约束到工作区',
    },
    coraPlan: {
        installed: 'Plan 约束已安装到当前工作区',
        confirmDelete: '确定要删除该 Plan 文件吗？',
        deleted: 'Plan 文件已删除',
        welcomeIntro: 'CoraPlan 将使用 DDD、TDD 的方法，辅助用户生成幻觉低、更可控的 plan 执行计划。',
        welcomeButton: '在此工作区注入 CoraPlan',
    },
    sort: {
        title: '排序',
        placeHolder: '选择排序方式',
        nameAsc: '文件名 (A-Z)',
        nameDesc: '文件名 (Z-A)',
        mtimeDesc: '编辑时间 (从新到旧)',
        mtimeAsc: '编辑时间 (从旧到新)',
        ctimeDesc: '创建时间 (从新到旧)',
        ctimeAsc: '创建时间 (从旧到新)',
    },
    outline: {
        gotoHeading: '跳转到标题',
        collapsedAll: '大纲已全部折叠',
        expandedAll: '大纲已全部展开',
    },
    display: {
        fontFamily: '字体系列',
        fontSize: '字号',
        lineHeightPreview: '行间距（预览）',
        lineHeightSource: '行间距（Markdown）',
        current: '当前',
        selectOne: '选择一项即可生效',
        settingsTitle: '显示设置',
        compact: '紧凑',
        default: '默认',
        relaxed: '宽松',
        previewLabel: '预览',
        markdownLabel: 'Markdown',
        linePreset1_2: '1.2（紧凑）',
        linePreset1_35: '1.35',
        linePreset1_5: '1.5（默认）',
        linePreset1_6: '1.6',
        linePreset2: '2.0（宽松）',
    },
    preview: {
        tabPreview: '预览',
        tabMarkdown: 'Markdown',
        loadError: '无法加载编辑器资源',
        lineRefSingle: '第{n}行',
        lineRefRange: '第{start}-{end}行',
        addToChat: '加入对话 ⌘L',
        panelTitleSuffix: ' （编辑）',
        mermaidError: '图表语法错误',
        mermaidLoading: '正在加载图表引擎...',
        mermaidEngineFallback: '图表引擎未加载，显示源码：',
        mermaidLoadFailed: '图表引擎加载失败，以上为 Mermaid 源码',
        mermaidZoomIn: '放大',
        mermaidZoomOut: '缩小',
        mermaidDownloadPng: '下载为 PNG',
        mermaidClose: '关闭',
        mermaidDownloadSaved: '已保存：{path}',
        mermaidDownloadFailed: '保存 PNG 失败：{error}',
        openLinkFailed: '打开链接失败：{error}',
    },
    newNote: {
        untitledPrefix: '未命名笔记',
        prompt: '输入笔记文件名',
        createAt: '将创建于',
        nameRequired: '文件名不能为空',
        created: '已创建笔记',
        createFailed: '创建笔记失败',
    },
    newFolder: {
        prompt: '输入文件夹名称',
        createAt: '将创建于',
        nameRequired: '文件夹名称不能为空',
        created: '已创建文件夹',
        createFailed: '创建文件夹失败',
    },
    fileOp: {
        folder: '文件夹',
        file: '文件',
        deleteConfirm: '确定要删除{type} "{name}" 吗？',
        delete: '删除',
        deleted: '已删除{type}',
        deleteFailed: '删除{type}失败',
        renamePrompt: '重命名{type}',
        nameRequired: '名称不能为空',
        nameSame: '新名称不能与旧名称相同',
        renamed: '已重命名为',
        renameFailed: '重命名失败',
    },
};

const en: Messages = {
    common: {
        openPreview: 'Open Preview',
        openFile: 'Open File',
        copyPath: 'Copy Absolute Path',
        copyRelativePath: 'Copy Relative Path',
    },
    msg: {
        revealFailed: 'Failed to open in Finder',
        copiedAbsolutePath: 'Absolute path copied to clipboard',
        copiedAbsolutePathMulti: 'Copied absolute path of {n} file(s)',
        copyPathFailed: 'Failed to copy path',
        copiedRelativePath: 'Relative path copied to clipboard',
        copiedRelativePathMulti: 'Copied relative path of {n} file(s)',
        copyRelativePathFailed: 'Failed to copy relative path',
        copyFileSuffix: 'copy',
        copyFileSuffixWithNum: 'copy {n}',
        copiedFile: 'File copied: {name}',
        copyFileFailed: 'Failed to copy file',
        noWorkspace: 'Please open a workspace first',
        noMatch: 'No matching notes found',
        noMatchFallback: 'No files contain all keywords; showing {n} result(s) with any keyword',
        expandAllLater: 'Expand all will be improved in a later version',
        noActiveEditor: 'No active editor',
        selectFileFirst: 'Please select a file first',
        openFileFirst: 'Please open a file first',
        unknownFile: 'Cannot identify current file',
        openFailed: 'Open failed',
        installFailed: 'Install failed',
        deleteFailed: 'Delete failed',
    },
    search: {
        prompt: 'Enter search keyword(s)',
        placeHolder: 'Single keyword or multiple keywords (space-separated)',
        cleared: 'Search results cleared',
        matchCount: 'Match count',
        matches: '{n} match(es)',
    },
    coraWiki: {
        emptyHint: 'Use the title action to start CoraWiki research',
        welcomeIntro: 'CoraWiki uses AI to analyze code architecture and generate architecture reports.',
        welcomeButton: 'Start architecture analysis for current workspace',
        latestReportTag: 'latest',
        referencesTitle: 'References',
        queryPrompt: 'Enter a code architecture question',
        queryPlaceholder: 'e.g. What is the end-to-end order creation flow?',
        running: 'CoraWiki is analyzing code...',
        keyMissing: 'Environment variable {env} not found. Running in local fallback mode.',
        runFailed: 'CoraWiki run failed: {error}',
        reportSaved: 'CoraWiki report generated: {path}',
        alreadyRunning: 'A CoraWiki analysis is already running. Wait for it to finish or click Cancel in the notification.',
        cancelled: 'CoraWiki analysis cancelled',
        noReportFound: 'No CoraWiki report found yet. Please run research first.',
        openReportFailed: 'Failed to open CoraWiki report: {error}',
        openReferenceFailed: 'Failed to open reference: {ref}, error: {error}',
        deleteReportConfirm: 'Delete report "{name}"?',
        deleteReportConfirmMulti: 'Delete selected {n} report(s)?',
        deleteAction: 'Delete',
        deleteReportDone: 'Report deleted',
        deleteReportDoneMulti: 'Deleted {n} report(s)',
        deleteReportFailed: 'Failed to delete report: {error}',
        pythonNotFound: 'Python or CoraWiki Python environment not available. Skip Python analysis for this run?',
        pythonSkip: 'Skip',
        pythonOpenWebsite: 'Open Python website',
        pythonError: 'Python execution failed: {error}. How to fix?',
        pythonRetry: 'Retry',
    },
    cmd: {
        openPlanConstraints: 'Open plan constraints',
        openPlanReadme: 'Open README registry',
        installPlanConstraintsToWorkspace: 'Install plan constraints to workspace',
    },
    coraPlan: {
        installed: 'Plan constraints installed to workspace.',
        confirmDelete: 'Delete this plan file?',
        deleted: 'Plan file deleted.',
        welcomeIntro: 'CoraPlan uses DDD and TDD approaches to help you generate low-hallucination, more controllable plan execution.',
        welcomeButton: 'Set up CoraPlan in this workspace',
    },
    sort: {
        title: 'Sort',
        placeHolder: 'Choose sort order',
        nameAsc: 'Name (A-Z)',
        nameDesc: 'Name (Z-A)',
        mtimeDesc: 'Modified (newest first)',
        mtimeAsc: 'Modified (oldest first)',
        ctimeDesc: 'Created (newest first)',
        ctimeAsc: 'Created (oldest first)',
    },
    outline: {
        gotoHeading: 'Go to Heading',
        collapsedAll: 'Outline collapsed',
        expandedAll: 'Outline expanded',
    },
    display: {
        fontFamily: 'Font family',
        fontSize: 'Font size',
        lineHeightPreview: 'Line height (Preview)',
        lineHeightSource: 'Line height (Markdown)',
        current: 'Current',
        selectOne: 'Select one to apply',
        settingsTitle: 'Display settings',
        compact: 'Compact',
        default: 'Default',
        relaxed: 'Relaxed',
        previewLabel: 'Preview',
        markdownLabel: 'Markdown',
        linePreset1_2: '1.2 (Compact)',
        linePreset1_35: '1.35',
        linePreset1_5: '1.5 (Default)',
        linePreset1_6: '1.6',
        linePreset2: '2.0 (Relaxed)',
    },
    preview: {
        tabPreview: 'Preview',
        tabMarkdown: 'Markdown',
        loadError: 'Failed to load editor resources',
        lineRefSingle: 'line {n}',
        lineRefRange: 'lines {start}-{end}',
        addToChat: 'Add to Chat ⌘L',
        panelTitleSuffix: ' (Edit)',
        mermaidError: 'Diagram syntax error',
        mermaidLoading: 'Loading diagram engine...',
        mermaidEngineFallback: 'Chart engine not loaded, showing source:',
        mermaidLoadFailed: 'Chart engine failed to load, above is Mermaid source.',
        mermaidZoomIn: 'Zoom in',
        mermaidZoomOut: 'Zoom out',
        mermaidDownloadPng: 'Download as PNG',
        mermaidClose: 'Close',
        mermaidDownloadSaved: 'Saved: {path}',
        mermaidDownloadFailed: 'Failed to save PNG: {error}',
        openLinkFailed: 'Failed to open link: {error}',
    },
    newNote: {
        untitledPrefix: 'Untitled note',
        prompt: 'Enter note filename',
        createAt: 'Will be created in',
        nameRequired: 'File name cannot be empty',
        created: 'Note created',
        createFailed: 'Failed to create note',
    },
    newFolder: {
        prompt: 'Enter folder name',
        createAt: 'Will be created in',
        nameRequired: 'Folder name cannot be empty',
        created: 'Folder created',
        createFailed: 'Failed to create folder',
    },
    fileOp: {
        folder: 'folder',
        file: 'file',
        deleteConfirm: 'Delete {type} "{name}"?',
        deleteConfirmMulti: 'Delete selected {n} item(s)?',
        delete: 'Delete',
        deleted: 'Deleted {type}',
        deletedMulti: 'Deleted {n} item(s)',
        deleteFailed: 'Failed to delete {type}',
        deleteFailedMulti: 'Delete failed (some or all)',
        renamePrompt: 'Rename {type}',
        nameRequired: 'Name cannot be empty',
        nameSame: 'New name must be different',
        renamed: 'Renamed to',
        renameFailed: 'Rename failed',
    },
};

function getMessages(): Messages {
    return isChinese() ? zh : en;
}

function interpolate(s: string, vars: Record<string, string | number>): string {
    return s.replace(/\{(\w+)\}/g, (_, k) => String(vars[k] ?? `{${k}}`));
}

/** Get a message by key path, e.g. t('msg.copiedAbsolutePath') or t('search.matches', { n: 3 }) */
export function t(key: string, vars?: Record<string, string | number>): string {
    const messages = getMessages();
    const parts = key.split('.');
    let v: unknown = messages;
    for (const p of parts) {
        v = (v as Record<string, unknown>)?.[p];
    }
    const s = typeof v === 'string' ? v : key;
    return vars ? interpolate(s, vars) : s;
}

/** Current messages (for tests); reflects active display language. */
export const messages = (): Messages => getMessages();
