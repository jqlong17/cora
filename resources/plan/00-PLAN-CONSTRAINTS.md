# Plan 创建约束

每次新建或修改本目录下 `*.plan.md` 前，请先完整阅读本文档并按其约束执行。

---

## 产品能力简述（面向用户展示）

本段为 CoraPlan 面向用户的产品能力说明，扩展空态等**从此处动态读取**；修改此处即可更新用户所见，无需改代码。

CoraPlan 将使用 DDD、TDD 的方法，辅助用户生成幻觉低、更可控的 plan 执行计划。

---

## 1. 目的与适用范围

本文档定义**创建/修改** `.cursor/plans/*.plan.md` 时的约束与结构要求，使 plan 在方法论上对齐 DDD（领域驱动设计）与 TDD（测试驱动开发），并保证可执行、可验收、可追溯。写 plan 前**必须**先阅读并**严格遵循**以下约定，不得臆测或省略。

### 1.1 使用方式（强制）

- **不推荐使用 Cursor 自带的 Plan 功能**：其与本文约束易不一致，易引发大模型幻觉或漏掉测试/验收要求。
- **推荐做法**：在 **Agent 模式**下直接让 AI 根据本文档约束生成 plan（或打开本目录/@ 本约束后再生成），并在同一会话中按 plan 执行；这样约束注入完整、执行可追溯。

---

## 2. 何时写 Plan

- **需要写 plan**：多步骤、多模块、需多人或跨会话协作的任务；涉及多个文件/层级的改动；需要明确验收与测试要求的需求。
- **可不写 plan**：单文件、单点、一次性可完成的简单修改；纯探索或临时脚本。

---

## 3. 文件名与编号约定

- **约定**：本目录下新建的 plan 文件**必须**以两位数字编号开头，格式为 `NN-简短名称.plan.md`，例如 `01-xxx.plan.md`、`02-xxx.plan.md`。
- **保留**：`00-` 专用于约束文档（如 `00-PLAN-CONSTRAINTS.md`），不得用于普通 plan。
- **取号**：新建 plan 前**必须**先查看本目录下已有文件名，取**当前已用最大编号 +1** 作为新 plan 的编号；若当前最大为 `01`，则新 plan 为 `02-...`。**必须**参考 [README.md](README.md) 登记表核对编号。
- **说明**：既有未编号的 plan 可保留不动；新 plan 一律使用编号，便于排序与 README 登记表对应。
- **规则生效（强制）**：创建/重写 plan 前，**必须**先打开本文件或本目录下任意 plan 文件，或在对话中 @ `.cursor/rules/plan-creation.mdc`，确保规则已注入后再开始撰写。
- **违规处理（强制）**：若文件名不符合 `NN-*.plan.md`、编号重复或未按「最大编号 +1」取号，**一律先重命名并修正编号，再继续写作**；不允许在不合规文件名下继续产出正文。
- **登记处理（强制）**：每次新增 `NN-*.plan.md` 后，**必须**立即在 [README.md](README.md) 登记表追加对应条目（编号、文件名、name、overview/简介）。

---

## 4. Frontmatter 约定

每个 plan 文件必须以 YAML frontmatter 开头，且包含：

| 字段 | 必填 | 说明 |
|------|------|------|
| `name` | 是 | 计划名称，简短可识别。 |
| `overview` | 是 | 一段话概述本计划要解决的问题与范围。 |
| `todos` | 是 | 数组；每项含 `id`、`content`、`status`（如 pending / in_progress / completed）。 |
| `isProject` | 否 | 布尔，标识是否为项目级计划。 |

示例：

```yaml
---
name: 某功能优化
overview: 在单份计划中涵盖 A、B、C 三项改动，并确保每项有测试与验收。
todos:
  - id: task-a
    content: 实现 A 并补充单元测试
    status: pending
  - id: task-b
    content: 实现 B 并补充 e2e
    status: pending
isProject: false
---
```

---

## 5. 正文结构约定

正文**必须**按以下顺序组织，**每个模块**都**必须**具备「现状 → 目标 → 实现要点 → 验收」，不得跳节或合并。

### 5.1 完成标准与测试要求（必须放在最前）

在正文**最前**（Frontmatter 之后）**必须**明确全局契约，**测试与功能必须同步开发**：

- **每个模块都必须具备**该模块的**独立单元测试**与**e2e 测试**（二者缺一不可，不可写「若适用」省略 e2e）。
- **仅当该模块的单元测试与 e2e 测试均通过后**，该模块对应的 task 才能标记为完成；**禁止在测试未通过的情况下将任务状态更新为 completed**。
- 实现功能的同时（或先写测试再实现）编写/更新对应测试，不得在功能开发完成后再补测。

### 5.2 按模块分节

每个模块一节，每节包含：

| 段落 | 说明 |
|------|------|
| **现状** | 当前代码/配置/行为的事实描述，可引用文件与行号。 |
| **目标** | 期望达到的状态或行为。 |
| **实现要点** | 具体修改点：涉及哪些文件、函数、配置；必要时给出行号或模块名，便于执行时定位。 |
| **验收** | 可执行的验收条件：**单元测试**（对哪类输出/行为做断言）+ **e2e 测试**（该模块必须都有）；二者均通过后才可标记该模块完成。 |

### 5.3 依赖与实现顺序（文末必须写明）

在文末**必须**说明：

- 模块之间的依赖关系（谁依赖谁）。
- **必须**写明实现顺序（如 1 → 2 → 3，或 1、2 并行后再做 3）。

**禁止**无顺序、无依赖的「大泥球」式开发；未写依赖与顺序的 plan 视为不合规。

---

## 6. 方法论（DDD / TDD 对齐）

### 6.1 DDD 思想在 Plan 中的体现

- **限界上下文**：每个 plan 有明确的 name + overview，一次 plan 只解决一个「有边界的」目标集，不泛泛而谈。
- **现状 → 目标 → 实现要点**：先界定当前域状态，再声明目标状态，最后给出在代码/配置中的落点（等价于聚合根与修改点）。
- **契约先行**：在正文最前**必须**写「完成标准与测试要求」，规定完成条件，相当于领域内的完成契约。
- **依赖与顺序**：文末**必须**明确依赖与实现顺序，**禁止**随意堆叠模块、不写顺序。

### 6.2 TDD 思想在 Plan 中的体现

- **测试与功能同步开发**：每个模块在实现功能时必须同步（或先行）编写单元测试与 e2e 测试，不得先写完功能再补测。
- **验收即测试**：每个模块的「验收」段必须包含可执行的测试要求（**单元测试 + e2e 测试**，二者必备），**仅当测试全部通过后**才能将对应 task 标记为完成。
- **先定验收再实现**：写「实现要点」时同步写「验收」，即先定义「怎样算完成」，再写「怎么实现」，与 TDD 的「先写测试再写实现」同构。
- **可断言、可回归**：验收条件要具体到可断言的行为或输出（如「对某函数首轮/后续轮输出结构的断言」「报告结构符合模版」），便于自动化与回归。

### 6.3 可追溯

实现要点中**必须**引用**具体文件与行号**（或模块/函数名），便于执行时定位；**禁止**仅用「改一下逻辑」「优化某处」等模糊描述。

---

## 7. 禁止项

- **无验收条件即标记完成**：每个模块必须有「验收」段，且验收包含单元测试与 e2e 测试要求。
- **没有测试通过就更新任务状态**：**禁止在单元测试与 e2e 测试均未通过的情况下将 task 标记为 completed**；测试必须通过后才能更新任务。
- **模块缺少单元测试或 e2e 测试**：每个模块都必须配备单元测试与 e2e 测试，不得以「若适用」或「可选」省略 e2e。
- **功能与测试不同步**：不得先完成功能再补测，测试与功能必须同步开发（或先写测试再实现）。
- **不写依赖与顺序**：多模块 plan **必须**在文末给出依赖与实现顺序；未写即违规。
- **实现要点无法定位**：**禁止**仅用「改一下逻辑」「优化某处」等模糊表述；**必须**点名文件/行号或模块/函数。
- **命名不合规仍继续写**：禁止在未满足 `NN-*.plan.md`、编号唯一、按序取号的情况下继续撰写 plan。
- **新增 plan 不登记**：新增 plan 未更新 [README.md](README.md) 登记表即视为未完成。

---

撰写新 plan 时，**必须**先对照上述约束自检（含：文件名是否以 `NN-` 开头、编号是否唯一且按序、是否含完成标准与测试要求、每模块是否有验收与单元/e2e、文末是否有依赖与顺序），自检通过后再提交或交由 AI 执行。**禁止**在未满足任一条约束的情况下将 plan 视为完成。

---

**维护说明**：修改本文档或 `.cursor/rules/plan-creation.mdc` 后，发布/打包前请执行 `npm run sync-plan`，将约束同步到 `resources/plan/`，这样扩展内嵌的约束与「产品能力简述」会保持最新。
